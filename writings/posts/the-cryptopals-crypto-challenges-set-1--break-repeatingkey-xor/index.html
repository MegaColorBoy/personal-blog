<!DOCTYPE html>
<html data-theme="" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="author" content="Abdush Shakoor">
	
	<meta name="description" content="Write a method that decodes a message which is encrypted using the Repeating-Key XOR cipher..">
	<meta name="og:title" content="The Cryptopals Crypto Challenges: Set 1 - Break Repeating-Key XOR | Abdush Shakoor's Weblog" />
	<meta name="og:type" content="article" />
	<meta name="og:url" content="writings/posts/the-cryptopals-crypto-challenges-set-1--break-repeatingkey-xor" />
	<meta name="og:description" content="Write a method that decodes a message which is encrypted using the Repeating-Key XOR cipher." />
	<meta name="og:site_name" content="Abdush Shakoor's Weblog | Abdush Shakoor's Weblog" />
	
	<meta name="robots" content="follow">
	<title>The Cryptopals Crypto Challenges: Set 1 - Break Repeating-Key XOR | Abdush Shakoor's Weblog </title>
	<link rel="stylesheet" href="/static/css/main.css" type="text/css">
	<link rel="stylesheet" href="/static/css/pygments.css" type="text/css">

	<link rel="apple-touch-icon" sizes="57x57" href="/static/favicon/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/static/favicon/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/static/favicon/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/static/favicon/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/static/favicon/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/static/favicon/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/static/favicon/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/static/favicon/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/static/favicon/apple-icon-180x180.png">
<link rel="icon" type="image/static/favicon/png" sizes="192x192"  href="/static/favicon/android-icon-192x192.png">
<link rel="icon" type="image/static/favicon/png" sizes="32x32" href="/static/favicon/favicon-32x32.png">
<link rel="icon" type="image/static/favicon/png" sizes="96x96" href="/static/favicon/favicon-96x96.png">
<link rel="icon" type="image/static/favicon/png" sizes="16x16" href="/static/favicon/favicon-16x16.png">
<link rel="manifest" href="/static/favicon/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/static/favicon/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">
	
	<!-- <script src="https://unpkg.com/phosphor-icons"></script> -->
	<!-- <script>
		if(localStorage.theme){
			document.documentElement.setAttribute('data-theme', localStorage.getItem("theme"));
		}
	</script> -->
</head>
<body class="">
	<!-- Navbar -->
	<header class="header">
	<!-- Logo with Author Name -->
	<div class="author">
		<a href="/">
			<img src="/static/logo.png" alt="megacolorboy">
			<div class="name">
				<h1>Abdush Shakoor's Weblog</h1>
				<p>Writings, experiments & ideas.</p>
			</div>
		</a>
	</div>
	<!-- Logo with Author Name -->
	<nav>
		<ul class="menu">
			
				<li><a href="/about">About</a></li>
			
				<li><a href="/archive">Archive</a></li>
			
				<li><a href="/resume">Resume</a></li>
			
		</ul>
	</nav>	
</header>

<main>
	<div class="two-col-grid">
		<section id="primary">
			<div class="articles">
				
<div class="article">
	<div class="article-header">
		<h1 class="heading"><a href="/writings/posts/the-cryptopals-crypto-challenges-set-1--break-repeatingkey-xor">The Cryptopals Crypto Challenges: Set 1 - Break Repeating-Key XOR</a></h1>
		<p class="description">Write a method that decodes a message which is encrypted using the Repeating-Key XOR cipher.</p>
	</div>
	<div class="article-body">
		<p>This is the <a href="http://cryptopals.com/sets/1/challenges/6">sixth challenge</a> of Set 1 in The Cryptopals Crypto Challenges website. Previously, I spoke about these challenges and provided walkthroughs for the previous challenges, if you haven't read them, here are the links:</p>

<ul>
<li><a href="/posts/the-cryptopals-crypto-challenges">The Cryptopals Crypto Challenges</a></li>
<li><a href="/posts/the-cryptopals-crypto-challenges-set-1--convert-hex-to-base64">The Cryptopals Crypto Challenges: Set 1 - Convert Hex to Base64</a></li>
<li><a href="/posts/base64-encodingdecoding-using-bitwise-manipulation-in-c">Base64 Encoding / Decoding using Bitwise Manipulation in C++</a></li>
<li><a href="/posts/the-cryptopals-crypto-challenges-set-1--fixed-xor">The Cryptopals Crypto Challenges: Set 1 - Fixed XOR Cipher</a></li>
<li><a href="/posts/the-cryptopals-crypto-challenges-set-1--singlebyte-xor-cipher">The Cryptopals Crypto Challenges: Set 1 - Single-Byte XOR Cipher</a></li>
<li><a href="/posts/the-cryptopals-crypto-challenges-set-1--detect-singlecharacter-xor">The Cryptopals Crypto Challenges: Set 1 - Detect Single-Character XOR</a></li>
<li><a href="/posts/the-cryptopals-crypto-challenges-set-1--implement-repeatingkey-xor">The Cryptopals Crypto Challenges: Set 1 - Implement Repeating-Key XOR</a></li>
<li><a href="/posts/hamming-distance-algorithm-in-c">Hamming Distance Algorithm in C++</a></li>
</ul>

<p>For this challenge, you are given a <a href="http://cryptopals.com/static/challenge-data/6.txt">file</a>, which contains a ciphertext that has been encrypted using <a href="/posts/the-cryptopals-crypto-challenges-set-1--implement-repeatingkey-xor">Repeating-Key XOR</a> and then encoded using Base64. Decrypt it.</p>

<p>According to the problem description on the website:</p>

<blockquote>
  <p>It is officially on, now.</p>
  
  <p>This challenge isn't conceptually hard, but it involves actual
  error-prone coding. The other challenges in this set are there to
  bring you up to speed. This one is there to qualify you. If you can do
  this one, you're probably just fine up to Set 6.</p>
</blockquote>

<p>Well, conceptually, this may not be the hardest but practically, it is the first hardest challenge in this set and it really did take me a while to understand how to decrypt the ciphertext through <strong><em>trial-and-error</em></strong> despite the instructions given on the website. In this challenge, it's more like connecting all the puzzles and looking at the big picture, in this case, all of the previous code that I had written, is to break the Repeating-Key XOR cipher.</p>

<h2>How to break it?</h2>

<p>The challenge had given some steps to follow. Here's how:</p>

<ol>
<li>Let <strong><em>KEYSIZE</em></strong> be the guessed length of the key; try values from 2 to (say) 40</li>
<li>Write a function to compute the edit distance/Hamming distance between two strings. To know more about it, <a href="/posts/hamming-distance-algorithm-in-c">click here</a> </li>
<li>For each <strong><em>KEYSIZE</em></strong>, take the first <strong><em>KEYSIZE</em></strong> worth of bytes, and the second <strong><em>KEYSIZE</em></strong> worth of bytes, and find the edit distance between them. Normalize this result by dividing by <strong><em>KEYSIZE</em></strong></li>
<li>The <strong><em>KEYSIZE</em></strong> with the smallest normalized edit distance is probably the key. You could proceed perhaps with the smallest 2-3 <strong><em>KEYSIZE</em></strong> values. Or take 4 <strong><em>KEYSIZE</em></strong> blocks instead of 2 and average the distances</li>
<li>Now that you probably know the <strong><em>KEYSIZE</em></strong>: break the ciphertext into blocks of <strong><em>KEYSIZE</em></strong> length</li>
<li>Now transpose the blocks: make a block that is the first byte of every block, and a block that is the second byte of every block, and so on</li>
<li>Solve each block as if it was single-character XOR. You already have code to do this</li>
<li>For each block, the single-byte XOR key that produces the best looking histogram is the repeating-key XOR key byte for that block. Put them together and you have the key</li>
</ol>

<p>Let's dive in to the code (I hope the comments, help you out!):</p>

<p><strong>Implementation of the method(s):</strong></p>

<pre><code>//Single Byte XOR V2 - a better version
string CryptoLib::singleByteXOR_V2(string str, char key)
{
    //Don't forget to add a NULL character to the string, it broke when I didn't add it previously.
    string newStr(str.size(),''); 

    for(int i=0; i&amp;lt;str.size(); ++i){
        newStr[i] = str[i] ^ key;
    }
    return newStr;
}

//Return the Single Byte XOR key via Bruteforce
char CryptoLib::singleByteXOR_Bruteforce_key(string cipherBlock)
{
    char key = 0;
    int maxCount=0;
    string decodedMessage;

    //Brute force all 256 possibilities
    for(int i=0; i&lt;=256; i++)
    {
        char ch = (char) i;

        //Perform Single Byte XOR -- modified version
        string attempt = singleByteXOR_V2(cipherBlock, ch);

        // cout &lt;&lt; "Message: " &lt;&lt; attempt &lt;&lt; endl;

        int count = 0;
        /*
            Look for characters that are alphabetic and the space character,
            if it finds, increment the counter
        */
        for(int j=0; j&amp;lt;attempt.size(); j++)
        {
            if((attempt[j] &gt;= 65 &amp;&amp; attempt[j] &lt;= 122) || attempt[j] == ' ')
            {
                count++;
            }
        }

        //The one with the highest count, has the predicted key
        if(count &gt; maxCount)
        {
            maxCount = count;
            key = ch;
            // decrypted = attempt;
        }
    }

    // cout &lt;&lt; "KEY: " &lt;&lt; key &lt;&lt; endl;
    // cout &lt;&lt; "MESSAGE: " &lt;&lt; decrypted &lt;&lt; endl;

    return key;
}

//Guess Key length of the cipher
int CryptoLib::guess_key_length(string cipherText)
{
    int KEYSIZE = -1;
    double leastNormalized = INT_MAX;

    //Guess a keysize from 2 to 40
    for(int i=2; i&lt;=40; i++)
    {
        double normalize = 0.0f;

        //Number of bytes per key size
        int bytes = cipherText.size()/i;

        for(int j=0; j&amp;lt;bytes; j++)
        {
            string blockA = cipherText.substr((j*i), i);
            string blockB = cipherText.substr(((j+1)*i), i);

            //Calculate Hamming Distance between 2 strings
            int edit_distance = hamming_distance(blockA, blockB);

            normalize += ((double)edit_distance)/((double)blockA.size());
        }

        //Now, take an average 
        normalize /= bytes;

        //The key size that has the least edit distance is the key size required
        if(normalize &gt; 0 &amp;&amp; normalize &lt; leastNormalized)
        {
            leastNormalized = normalize;
            KEYSIZE = i;
        }
    }

    //Return the key size
    return KEYSIZE;
}
</code></pre>

<p><strong>Final code:</strong></p>

<pre><code>//The Cryptopals Crypto Challenges - Set 1 Challenge 6
#include "crypto.h"

int main()
{
    CryptoLib crypt;
    string message;
    string binary;
    string key;

    //if this returns 37, then the function is working correct!
    // cout &lt;&lt; crypt.hamming_distance("this is a test", "wokka wokka!!!") &lt;&lt; endl;

    //Read the file content
    ifstream infile;

    //Converted the B64 text to Hexadecimals through an online converter
    //as it wasn't accurate with b64 decoder that I'd built
    infile.open("message.txt");
    getline(infile, message, '');
    infile.close();

    //Convert the hexadecimal string to ASCII
    message = crypt.con_hex_2_ascii(message);

    //Guess the length of the key
    int keyLength = crypt.guess_key_length(message);

    //Transpose the message based on keysize length
    int blocks = message.size() / keyLength;

    for(int i=0; i&amp;lt;keyLength; ++i)
    {
        string block;
        char indexKey='';

        /*
            Transpose the message into blocks 
            based on keysize and concatenate it 
            into one string
        */
        for(int j=0; j&amp;lt;blocks; j++){
            block += message.substr((j*keyLength) + i,1);
        }

        //Concatenate the selected characters, which will become the predicted key
        key += crypt.singleByteXOR_Bruteforce_key(block);
    }

    cout &lt;&lt; "KEY: " &lt;&lt; key &lt;&lt; endl;
    cout &lt;&lt; "DECODED: " &lt;&lt; crypt.con_hex_2_ascii(crypt.repeatingKeyXOR(message, key)) &lt;&lt; endl;

    return 0;   
}
</code></pre>

<p><strong><em>Note: This solution and the library named <code>crypto.h</code> was built using the C++ programming language. The source code for this solution can be found on Github.</em></strong></p>

<p>When the following code is executed, the most probable <strong><em>KEYSIZE</em></strong> is <strong><em>29</em></strong> and after transposing the message and decrypting the blocks, you get a key of that length:</p>

<pre><code>Terminator X: Bring the noise
</code></pre>

<p>Lastly, use the <strong><em>Repeating-Key XOR</em></strong> method to decrypt the message with the cracked key (which looks like lyrics to some music track!):</p>

<pre><code>A rockin' on the mike while the fly girls yell
Well that's my DJ Deshay cuttin' all them Z's
Vanilla's on the mike, man I'm not lazy. ?I'm lettin' my drug kick in
To just let it flow, let my concepts go
And if you don't give a damn, then
So get off 'cause I control the stage
I'm in my own phase
And I can dance better than any kid n' play ?
Stage 2 -- Yea the one ya' wanna listen to
So I can funk it up and make it sound good
For good luck, I like my rhymes atrocious
I'm an effect and that you can bet
There's no denyin', You can try to hang 
Over and over, practice makes perfect
Soon -- Oh my God, homebody, you probably eat
Intoxicating so you stagger like a wino
Vanilla Ice is sellin' and you people are buyin'
Movin' and groovin' trying to sing along
Now you're amazed by the VIP posse. ?
Steppin' so hard like a German Nazi
There's no trippin' on mine, I'm just gettin' down
You trapped me once and I thought that
So step down and lend me your ear 
Your body's gettin' hot, so, so I can smell it
'Cause the lyrics belong to ICE, You can call me Dad 
Let the witch doctor, Ice, do the dance to cure 
You wanna battle me -- Anytime, anywhere ?
You thought that I was weak, Boy, you're dead wrong 
play that funky music Go white boy, go white boy, go
Play that funky music white boy you say it, say it 
Play that funky music, white boy Come on, Come on, Come on
</code></pre>

<p>As mentioned above, this was really challenging and fun, at the same time. Although, Most people (academically) know <strong><em>"how-to"</em></strong> break a Repeating-Key XOR (Vignere Cipher) but being <strong><em>able</em></strong> to break it, is another thing.</p>

<p>Hope you liked reading this article!</p>

<p>But, hang in there, surprisingly, this code will be useful later on for many problems.</p>

	</div>
	<div class="article-footer">
		<time>December 18th, 2017</time>
		<ul class="tags">
			
			<li>
				<a href="/category/cryptography/">
					Cryptography
				</a>
			</li>
			
		</ul>
	</div>
</div>

			</div>
		</section>
		<section id="secondary">
			<div class="sidebar">
				<div class="author-intro">
	<h3>Hello, I'm Abdush Shakoor! &#x1F44B;</h3>
	<p>I'm a programmer & designer based in Dubai, United Arab Emirates. I love tinkering with code and writing about what I learn.</p>
	<p>Like this article? Please share it with your friends and colleagues or else, <a href="mailto:megacolorboy@gmail.com">send me</a> a private message about your feedback.</p>

	<ul class="sitemap">
		<li><a class="back" href="/"><span>👈</span> Check out more articles!</a></li>
	</ul>
</div>
			</div>
		</section>
	</div>
</main>

<footer>
    <span class="copyright">&copy; Abdush Shakoor</span>
</footer>

<script src="/static/vendor/jquery/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

<script src="/static/js/art.js"></script>

<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script defer id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-98290003-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-98290003-2');
</script>
<script src="/static/vendor/jquery-lazy/jquery.lazy.min.js"></script>
<script>
  $(function () {
    $('.lazy').lazy();
  });
</script>
<!-- <script>
    const darkModeButton = document.createElement('button');
    const syntaxHighlightSource = document.getElementById('syntaxHighlight');
    const menuList = document.querySelector('.menu');
    const themeSettings = {
        "dark": {
            "icon": '<i class="ph-moon-fill"></i>',
            "hljs": "/static/vendor/hljs/css/github-dark.css",
        },
        "light": {
            "icon": '<i class="ph-sun-fill"></i>',
            "hljs": "/static/vendor/hljs/css/github.min.css",
        },
    }

    function highlightMenuLink() {
        var currentURI = window.location.href;
        currentURI = currentURI.replace(window.location.protocol + "//", "");
        var currentPage	 = currentURI.split('/')[1];

        if(currentPage) {
            $('a[href="/' + currentPage + '"').parent().addClass('active');
        }
    }
    
    function initThemeSwitcher() {
        darkModeButton.innerHTML = themeSettings.light.icon;
        darkModeButton.classList.add('darkModeButton');
        
        darkModeButton.addEventListener('click', function(){
            switch(document.documentElement.getAttribute('data-theme')) {
                case 'dark':
                    lightMode();
                    break;

                case 'light':
                default:
                    darkMode();
                    break;
            }
        });
        
        var newItem = document.createElement('li');
        newItem.appendChild(darkModeButton);
        menuList.insertBefore(newItem, menuList.childNodes[menuList.childNodes - 1]);
    }
    

    // Settings for dark mode
    function darkMode() {
        darkModeButton.innerHTML = themeSettings.dark.icon;
        document.documentElement.setAttribute('data-theme', 'dark');
        syntaxHighlightSource.setAttribute('href', themeSettings.dark.hljs);
        localStorage.setItem("theme", "dark");
    }

    // Settings for light mode
    function lightMode() {
        darkModeButton.innerHTML = themeSettings.light.icon;
        document.documentElement.setAttribute('data-theme', '');
        syntaxHighlightSource.setAttribute('href', themeSettings.light.hljs);
        localStorage.setItem("theme", "");
    }

    function checkTheme() {
        const localStorageTheme = localStorage.getItem("theme");
        switch(localStorageTheme) {
            case "dark":
                darkMode();
                break;
            
            default:
                lightMode();
                break;
        }
    }

    // Check if the theme is stored in session
    window.onload = function() {
        initThemeSwitcher();
        checkTheme();
        highlightMenuLink();
    }

    //  open and close nav 
    $('#navbar-toggle').click(function() {
      $('nav ul').slideToggle();
    });

    // Hamburger toggle
    $('#navbar-toggle').on('click', function() {
      this.classList.toggle('active');
    });

    // Click outside the dropdown will remove the dropdown class
    $('html').click(function() {
      $('.navbar-dropdown').hide();
    });
</script> -->
</body>
</html>